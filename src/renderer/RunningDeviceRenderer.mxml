<?xml version="1.0" encoding="utf-8"?>
<s:ItemRenderer xmlns:fx="http://ns.adobe.com/mxml/2009" 
				xmlns:s="library://ns.adobe.com/flex/spark" 
				xmlns:mx="library://ns.adobe.com/flex/mx" 
				autoDrawBackground="true" height="40"
				removedFromStage="removedFromStageHandler(event)"
				toolTip="{dev.tooltip}">
	
	<fx:Script>
		<![CDATA[
			import flash.filters.BitmapFilterQuality;
			
			import mx.core.DragSource;
			import mx.core.FlexGlobals;
			import mx.managers.DragManager;
			import mx.managers.PopUpManager;
			
			import spark.filters.DropShadowFilter;
			
			import device.Device;
			import device.IosDevice;
			
			public static const dropShadowFilterMiddle:DropShadowFilter = new DropShadowFilter(4.0, 45, 0x000000, 0.2, 8.0, 8.0, 0.9, BitmapFilterQuality.HIGH, false, false, false);
			
			[Bindable]
			private var dev:Device;
			
			private function showWindow(event:MouseEvent, dev:Device):void{
				var tw:DeviceSettingsWindow = new DeviceSettingsWindow();
				tw.dev = dev;
				PopUpManager.addPopUp(tw, this, true);
				PopUpManager.centerPopUp(tw);
			}
			
			private function goHome(event:MouseEvent, dev:Device):void{
				var request:URLRequest = new URLRequest();
				var urlLoader:URLLoader = new URLLoader();
				
				request.url = "http://" + dev.ip + ":" + dev.port + "/button";
				request.contentType = "text/plain";
				request.method = URLRequestMethod.POST;
				request.data = "home";
				
				urlLoader = new URLLoader();
				urlLoader.dataFormat = URLLoaderDataFormat.TEXT;
				urlLoader.load(request);
			}
			
			override public function set data(value:Object):void
			{
				super.data = value;
				this.dev = value as Device;
				
				if(this.dev is IosDevice){
					mobile.source = "assets/icons/32/ios.png";
				}else{
					mobile.source = "assets/icons/32/android.png";
				}
			}
			
			protected function restart_clickHandler(event:MouseEvent):void
			{
				FlexGlobals.topLevelApplication.restartDevice(dev);
			}
			
			protected function mainGroup_rollOverHandler(event:MouseEvent):void
			{
				restartButton.includeInLayout = true;
				restartButton.visible = true;
				homeButton.visible = dev.status == "ready";
				homeButton.includeInLayout = dev.status == "ready";
				iconStatus.visible = false;
				iconStatus.includeInLayout = false;
				
				if(this.dev is IosDevice) {
					settingsButton.includeInLayout = true;
					settingsButton.visible = true;
				}
			}
			
			protected function mainGroup_rollOutHandler(event:MouseEvent):void
			{
				if(this.dev is IosDevice) {
					settingsButton.includeInLayout = false;
					settingsButton.visible = false;
				}
				restartButton.includeInLayout = false;
				restartButton.visible = false;
				homeButton.visible = false;
				homeButton.includeInLayout = true;
				iconStatus.visible = true;		
				iconStatus.includeInLayout = true;
			}
			
			protected function removedFromStageHandler(event:Event):void
			{
				mainGroup.filters = []
			}
			
			override protected function get hovered():Boolean { return false; }
			//override protected function get down():Boolean { return false; }
			override public function get selected():Boolean { return false; }
			//override public function get showsCaret():Boolean { return false; }
			
			protected function mouseDownHandler(event:MouseEvent):void
			{
				if(dev.status == "ready"){
					firstGroup.addEventListener(MouseEvent.MOUSE_MOVE, mouseDownForDragHandler, false, 0, true);
				}
			}
			
			protected function mouseDownForDragHandler(event:MouseEvent):void{
				firstGroup.removeEventListener(MouseEvent.MOUSE_MOVE, mouseDownForDragHandler);
				
				var dragSource:DragSource = new DragSource();
				dragSource.addData("", "mobile");
				
				Clipboard.generalClipboard.setData(ClipboardFormats.TEXT_FORMAT, dev.ip + ":" + dev.port, false);
				
				DragManager.doDrag(this, dragSource, event, firstGroup, mouseX - 20, mouseY + 10, 1.0);
			}
		]]>
	</fx:Script>
	
	<s:HGroup id="mainGroup" width="100%" verticalAlign="middle" verticalCenter="0" filters="{dropShadowFilterMiddle}"
			  paddingRight="6" paddingLeft="2" rollOver="mainGroup_rollOverHandler(event)" rollOut="mainGroup_rollOutHandler(event)">
		<s:HGroup id="firstGroup" verticalAlign="middle" mouseDown="mouseDownHandler(event)" buttonMode="true" gap="0">
			<s:BitmapImage  id="mobile" source="assets/icons/32/android.png" smooth="true" smoothingQuality="high"/>
			<s:VGroup gap="3" mouseEnabled="false" verticalAlign="bottom" height="100%">
				<s:Label visible="{dev.ip==null}" includeInLayout="{dev.ip==null}" 
						 text="Unable to get local ip !" fontStyle="italic" color="0x8a844a"/>
				<s:HGroup visible="{dev.ip!=null}" includeInLayout="{dev.ip!=null}" gap="0">
					<s:Label text="{dev.ip}" fontWeight="bold" color="0x113b55"/>
					<s:Label text=":{dev.port}" color="0x113b55"/>
				</s:HGroup>
				
				<s:Label text="{dev.manufacturer} - {dev.modelName}" fontSize="11" fontStyle="italic" color="#758696"/>
				<s:Label visible="{dev.errorMessage != ''}" includeInLayout="{dev.errorMessage != ''}" text="{dev.errorMessage}" fontSize="11" fontStyle="italic" color="#FF0000"/>

			</s:VGroup>
		</s:HGroup>
		
		<s:Spacer width="100%"/>
		
		<s:Group id="homeButton" buttonMode="true" click="goHome(event, dev)"
				 toolTip="Device home button" visible="false" includeInLayout="false">
			<s:BitmapImage source="assets/icons/24/home.png" width="20" height="20" smooth="true" smoothingQuality="high"/>
		</s:Group>
		
		<s:Group id="settingsButton" buttonMode="true" click="showWindow(event, dev)"
				 toolTip="Settings of device" visible="false" includeInLayout="false">
			<s:BitmapImage source="assets/icons/24/run.png" smooth="true" smoothingQuality="high"/>
		</s:Group>
		
		<s:BitmapImage id="iconStatus" source="assets/icons/24/{dev.status}.png" smooth="true" smoothingQuality="high"/>
		<s:Group id="restartButton" buttonMode="true" click="restart_clickHandler(event)"
				 toolTip="Restart device" visible="false" includeInLayout="false">
			<s:BitmapImage source="assets/icons/24/restart.png" smooth="true" smoothingQuality="high"/>
		</s:Group>
	</s:HGroup>

</s:ItemRenderer>
