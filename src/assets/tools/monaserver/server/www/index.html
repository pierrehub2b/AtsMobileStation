<html><head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>ATS Mobile Station</title>
    <style type="text/css">
		ul {
		  list-style: none;
		}

		ul li::before {
		  content: "\2022";
		  color: blue;
		  font-weight: bold;
		  display: inline-block; 
		  width: 1em;
		  margin-left: -1em;
		}
    </style>
    <script type="text/javascript">
		var socket;
		
		function showInfos(name, description){
			document.getElementById("name").innerHTML = name;
			document.getElementById("info").innerHTML = description;
		}
		
		function checkLock(item, locked){
			if(locked == null){
				var lockImg = item.getElementsByTagName("img");
				if(lockImg.length > 0){
					item.removeChild(lockImg[0]);
				}
			}else{
				var img = document.createElement("img");
				img.src = "lock.png";
				item.appendChild(img);
			}
		}
	  
        // Reception handler
        function onMessage(msg) {
            try { // try to parse data
                data = JSON.parse(msg.data);
                switch (data[0]) {
                	case "msStatus":
                		if(data[1] == "close"){
                			document.getElementById("listDevices").innerHTML = "";
                		}
                		break;
					case "deviceConnected":
						
						var device = data[1];
						var endPoint = device["ip"] + ":" + device["port"];
						
						var item = document.createElement("li");
						item.appendChild(document.createTextNode(device.modelName + " (" + endPoint + ") "));
						item["endPoint"] = endPoint;
						
						document.getElementById("listDevices").appendChild(item);
												
						break;
					case "deviceRemoved":
						var device = data[1];
						var locked = device["lockedBy"];
						var endPoint = device["ip"] + ":" + device["port"];

						var list = document.getElementById("listDevices");
						var items = list.getElementsByTagName("li");
						for (var i = 0; i < items.length; ++i) {
							if(items[i]["endPoint"] == endPoint){
								list.removeChild(items[i]);
								break;
							}
						}
						break;
					case "deviceLocked":
						var device = data[1];
						var locked = device["lockedBy"];
						var endPoint = device["ip"] + ":" + device["port"];

						var list = document.getElementById("listDevices");
						var items = list.getElementsByTagName("li");
						for (var i = 0; i < items.length; ++i) {
							if(items[i]["endPoint"] == endPoint){
								checkLock(items[i], locked);
								break;
							}
						}
						break;
					case "infoUpdated":
						showInfos("[ " + data[1] + " ]", data[2]);
						break;
                }
            } catch(exception) {}
        }
              
        // Connection handler
        function onConnection() {
			socket.send(JSON.stringify(["initData"]));
        }
        
        // Disconnection handler
        function onDisconnection() { 

        }
        
        // Socket connector
        function createWebSocket() {
            host = "ws://" + window.location.host + "/mobilestation/";

            if(window.MozWebSocket)
                window.WebSocket=window.MozWebSocket;
            if(!window.WebSocket) {
                alert("Your browser don't support webSocket!");
                return false;
            }
            
            socket = new WebSocket(host);
            socket.onopen = onConnection;
            socket.onclose = onDisconnection;
            socket.onerror = function() { document.getElementById("info").value = 'An error occurs'; }
            socket.onmessage = onMessage;
            return true;
        }
        createWebSocket();
        
    </script>
</head>
<body>
<h2><span style="color: #3b3349;"><p>ATS Mobile Station <em><label id="name"/></p></span></h2>
<b>Description : </b><span style="color: #666699;"><em><label id="info"/></span> 
    <div style="height:95%; width:100%">
        <div style="width:100%%; height:100%; float: left">
            <ul id="listDevices"></ul>
        </div>
    </div>
</body>
<html>